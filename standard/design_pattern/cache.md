# 缓存

## 缓存穿透
缓存穿透是指查询一个一定不存在的数据. 由于缓存不命中, 并且出于容错考虑, 如果从数据库查不到数据则不写入缓存, 这将导致这个不存在的数据每次请求都要到数据库去查询,失去了缓存的意义.

正常业务情况下出现此问题的概率不大, 大多数都是遭到恶意攻击才会出现.

比如说合法ID是 snowflake 生成的正数, 但是攻击者使用负数ID请求服务, 如果在服务层面没有判断参数, 就会出现大量缓存穿透从而出现问题.

解决方法也很简单
- 在服务/控制器层面添加断言, 判断参数不合法时直接返回, 不查询数据库.
- 更新缓存时加锁, 没取到锁的请求直接返回或休眠后缓存, 从而避免大量请求直接访问数据库.

## 缓存雪崩
缓存雪崩是指同一或特短时间内大量缓存集体失效, 导致此时间内大量请求直接访问数据库.

一般而言, 如果在 set/update 缓存时, 设置了统一的过期时间可能会导致缓存集体失效, 从而出现此情况.

解决方法也很简单
- set/update redis时, 过期时间加一个随机值

## 缓存并发竞争key
当key操作不需要顺序: 竞争锁即可

当key操作需要顺序: 竞争锁, 且给每个操作加时间戳(思想其实都是一样的, 可以参考分布式系统设计/并发系统设计)

