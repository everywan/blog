# binlog
mysql 通过 binlog 记录数据库的更改操作, 以实现主从数据的复制.

启用 binlog 后, mysql 会将所有的数据库更改操作记录到binlog日志中, 可用于备份和复制.
- binlog 在事务最终提交后才会记录到binlog日志中, 且只有更改操作, 不包含 select 等查询操作.

binlog 多被用于主从复制. master 节点通过 binlog 生成日志, 从节点通过binlog复制数据.

详细参见
- [mysql5.7_binlog](https://dev.mysql.com/doc/refman/5.7/en/replication-options-binary-log.html#option_mysqld_log-bin)

## 使用
启用配置binlog: [配置文件示例](https://github.com/everywan/soft/setup/server/docker/mysql/conf.d/binlog.cnf)

## binlog_format
binlog 的多种记录格式
1. sbr(statement based replication): 基于语句. master节点将sql语句写入binlog. 从节点通过执行sql复制数据.
  - 仅记录sql
2. rbr(row based replication): 基于行. master节点将 event 写入binlog, event 即对表/行的更改. 从节点通过binlog复制数据.
  - rbr 模式记录的是 event, 会包含很多操作细节, 有以下特点: 日志内容增加, 需要解析 event.(rbr下, 部分更改操作是经过 base64 加密的(2019.10))
3. mixed: 混合模式. 同时使用两种模式. mix 模式下. 默认使用 row-based, 在特点情况下 切换为 statement-based

mysql5.7 默认 format 是 rbr.

statement-based 日志示例
````
// show binlog events IN 'ON.000001'
+-----------+-----+----------------+-----------+-------------+----------------------------------------------+
| Log_name  | Pos | Event_type     | Server_id | End_log_pos | Info                                         |
+-----------+-----+----------------+-----------+-------------+----------------------------------------------+
| ON.000001 | 4   | Format_desc    | 0         | 123         | Server ver: 5.7.27-log, Binlog ver: 4        |
| ON.000001 | 123 | Previous_gtids | 0         | 154         |                                              |
| ON.000001 | 154 | Anonymous_Gtid | 0         | 219         | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'         |
| ON.000001 | 219 | Query          | 0         | 298         | BEGIN                                        |
| ON.000001 | 298 | Query          | 0         | 404         | use `test`; insert into test values(6,"b",2) |
| ON.000001 | 404 | Xid            | 0         | 435         | COMMIT /* xid=22 */                          |
+-----------+-----+----------------+-----------+-------------+----------------------------------------------+

// vim -b ON.000001
00000000: fe62 696e 5ca4 9e5d 0f00 0000 0077 0000  .bin\..].....w..
00000010: 007b 0000 0001 0004 0035 2e37 2e32 372d  .{.......5.7.27-
00000020: 6c6f 6700 0000 0000 0000 0000 0000 0000  log.............
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 005c a49e 5d13  ...........\..].
00000050: 380d 0008 0012 0004 0404 0412 0000 5f00  8............._.
00000060: 041a 0800 0000 0808 0802 0000 000a 0a0a  ................
00000070: 2a2a 0012 3400 017f e3e5 e95c a49e 5d23  **..4......\..]#
00000080: 0000 0000 1f00 0000 9a00 0000 8000 0000  ................
00000090: 0000 0000 0000 1767 b11e 6aa4 9e5d 2200  .......g..j..]".
000000a0: 0000 0041 0000 00db 0000 0000 0001 0000  ...A............
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0200 0000 0000 0000 0001  ................
000000d0: 0000 0000 0000 00db a801 146a a49e 5d02  ...........j..].
000000e0: 0000 0000 4f00 0000 2a01 0000 0800 0200  ....O...*.......
000000f0: 0000 0000 0000 0400 0021 0000 0000 0000  .........!......
00000100: 0120 00a0 5500 0000 0006 0373 7464 0421  . ..U......std.!
00000110: 0021 00e0 000c 0174 6573 7400 7465 7374  .!.....test.test
00000120: 0042 4547 494e 0e47 88d1 6aa4 9e5d 0200  .BEGIN.G..j..]..
00000130: 0000 006a 0000 0094 0100 0000 0002 0000  ...j............
00000140: 0000 0000 0004 0000 2100 0000 0000 0001  ........!.......
00000150: 2000 a055 0000 0000 0603 7374 6404 2100   ..U......std.!.
00000160: 2100 e000 0c01 7465 7374 0074 6573 7400  !.....test.test.
00000170: 696e 7365 7274 2069 6e74 6f20 7465 7374  insert into test
00000180: 2076 616c 7565 7328 362c 2262 222c 3229   values(6,"b",2)
00000190: 10c4 1dc8 6aa4 9e5d 1000 0000 001f 0000  ....j..]........
000001a0: 00b3 0100 0000 0016 0000 0000 0000 0076  ...............v
000001b0: 1b72 d7                                  .r.
````

row-based binlog 示例
````
// show binlog events IN 'ON.000001'
+-----------+-----+----------------+-----------+-------------+---------------------------------------+
| Log_name  | Pos | Event_type     | Server_id | End_log_pos | Info                                  |
+-----------+-----+----------------+-----------+-------------+---------------------------------------+
| ON.000001 | 4   | Format_desc    | 0         | 123         | Server ver: 5.7.27-log, Binlog ver: 4 |
| ON.000001 | 123 | Previous_gtids | 0         | 154         |                                       |
| ON.000001 | 154 | Anonymous_Gtid | 0         | 219         | SET @@SESSION.GTID_NEXT= 'ANONYMOUS'  |
| ON.000001 | 219 | Query          | 0         | 291         | BEGIN                                 |
| ON.000001 | 291 | Table_map      | 0         | 342         | table_id: 105 (test.test)             |
| ON.000001 | 342 | Write_rows     | 0         | 388         | table_id: 105 flags: STMT_END_F       |
| ON.000001 | 388 | Xid            | 0         | 419         | COMMIT /* xid=4 */                    |
| ON.000001 | 419 | Rotate         | 0         | 459         | ON.000002;pos=4                       |
+-----------+-----+----------------+-----------+-------------+---------------------------------------+

// vim -b ON.000001
00000000: fe62 696e 65a6 9e5d 0f00 0000 0077 0000  .bine..].....w..
00000010: 007b 0000 0000 0004 0035 2e37 2e32 372d  .{.......5.7.27-
00000020: 6c6f 6700 0000 0000 0000 0000 0000 0000  log.............
00000030: 0000 0000 0000 0000 0000 0000 0000 0000  ................
00000040: 0000 0000 0000 0000 0000 0065 a69e 5d13  ...........e..].
00000050: 380d 0008 0012 0004 0404 0412 0000 5f00  8............._.
00000060: 041a 0800 0000 0808 0802 0000 000a 0a0a  ................
00000070: 2a2a 0012 3400 017f b437 6265 a69e 5d23  **..4....7be..]#
00000080: 0000 0000 1f00 0000 9a00 0000 8000 0000  ................
00000090: 0000 0000 0000 4c1c 6845 6ca6 9e5d 2200  ......L.hEl..]".
000000a0: 0000 0041 0000 00db 0000 0000 0000 0000  ...A............
000000b0: 0000 0000 0000 0000 0000 0000 0000 0000  ................
000000c0: 0000 0000 0000 0200 0000 0000 0000 0001  ................
000000d0: 0000 0000 0000 00a9 9f30 2c6c a69e 5d02  .........0,l..].
000000e0: 0000 0000 4800 0000 2301 0000 0800 0200  ....H...#.......
000000f0: 0000 0000 0000 0400 001a 0000 0000 0000  ................
00000100: 0120 00a0 5500 0000 0006 0373 7464 0421  . ..U......std.!
00000110: 0021 00e0 0074 6573 7400 4245 4749 4e69  .!...test.BEGINi
00000120: 796d 536c a69e 5d13 0000 0000 3300 0000  ymSl..].....3...
00000130: 5601 0000 0000 6900 0000 0000 0100 0474  V.....i........t
00000140: 6573 7400 0474 6573 7400 0303 0f03 023c  est..test......<
00000150: 0006 80cd 2528 6ca6 9e5d 1e00 0000 002e  ....%(l..]......
00000160: 0000 0084 0100 0000 0069 0000 0000 0001  .........i......
00000170: 0002 0003 fff8 0700 0000 0162 0200 0000  ...........b....
00000180: f853 aedd 6ca6 9e5d 1000 0000 001f 0000  .S..l..]........
00000190: 00a3 0100 0000 0004 0000 0000 0000 00e4  ................
000001a0: 074d 266f a69e 5d04 0000 0000 2800 0000  .M&o..].....(...
000001b0: cb01 0000 0000 0400 0000 0000 0000 4f4e  ..............ON
000001c0: 2e30 3030 3030 32a9 46e6 84              .000002.F..
````

参考: [Replication Formats](https://dev.mysql.com/doc/refman/5.7/en/replication-formats.html)

### 查看 binlog
binlog 生成的是二进制文件, 可以根据需要使用如下方式打开
1. `vim+xxd` 插件: vim 可以打开二进制文件, xxd 可以以16进制解析二进制文件(将数字变为ascii字符). 方法如下
  - 打开文件 `vim -b 0001`
  - 执行 `:%!xxd` 以16进制方式查看
  - 注: xxd: make a hexdump or do the reverse. linux 自带工具.
2. 使用 mysqlbinlog 程序: 
  - statement-based: `mysqlbinlog mysql-bin.000025` 即可
  - row-based: `mysqlbinlog mysql-bin.000025 -vv --base64-output=decode-rows`. row-based 必须加如上参数, 才能正确的解析出 event 的sql语句
3. 使用 sql 查询. 具体见下文中的 常用sql语句

需要注意的是, 对于 row-based 模式, 二进制/sql 均不能看到 insert/delete 语句, 必须通过 mysqlbinlog 转义并查看. (有可能有其他方法, 但是我没查到)

Q&A
1. 开启 binlog 后, 之前的修改记录会有么? 或者可以重新生成么?

## 常用sql
```SQL
-- 查看binlog状态
show variables like '%log_bin%'
-- 查看当前的binlog信息
SHOW MASTER LOGS
-- 查看某个 binlog 文件的事件
show binlog events IN 'binfile'
-- 刷新logs, 同时会生成一个新的 binfile
flush logs
-- 清空binlog日志
reset master
```
